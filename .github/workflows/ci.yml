name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  release:
    types: [published]

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  lint:
    name: ğŸ” ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v5

      - name: ğŸ“¦ è®¾ç½® Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¥ å®‰è£…ä¾èµ–
        run: npm ci

      - name: ğŸ” ESLint æ£€æŸ¥
        run: npm run lint

      - name: ğŸ“Š TypeScript ç±»å‹æ£€æŸ¥
        run: npx tsc --noEmit

  # å•å…ƒæµ‹è¯•
  test:
    name: ğŸ§ª è¿è¡Œæµ‹è¯•
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [18, 20]
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v5

      - name: ğŸ“¦ è®¾ç½® Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v5
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: ğŸ“¥ å®‰è£…ä¾èµ–
        run: npm ci

      - name: ğŸ§ª è¿è¡Œæµ‹è¯•
        run: npm run test:run

      - name: ğŸ“ˆ ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
        if: matrix.node-version == 18
        run: npm run test:coverage

      - name: ğŸ“Š ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
        if: matrix.node-version == 18
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          file: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella

  # æ„å»ºæ£€æŸ¥
  build:
    name: ğŸ—ï¸ æ„å»ºæ£€æŸ¥
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v5

      - name: ğŸ“¦ è®¾ç½® Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¥ å®‰è£…ä¾èµ–
        run: npm ci

      - name: ğŸ—ï¸ æ„å»ºé¡¹ç›®
        run: npm run build

      - name: ğŸ“¦ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: build-files
          path: dist/
          retention-days: 1

  # å®‰å…¨æ‰«æ
  security:
    name: ğŸ”’ å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v5

      - name: ğŸ“¦ è®¾ç½® Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¥ å®‰è£…ä¾èµ–
        run: npm ci

      - name: ğŸ” ä¾èµ–å®‰å…¨å®¡è®¡
        run: npm audit --audit-level=moderate

      - name: ğŸ›¡ï¸ CodeQL åˆ†æ
        uses: github/codeql-action/init@v3
        with:
          languages: javascript

      - name: ğŸ” è‡ªåŠ¨æ„å»º
        uses: github/codeql-action/autobuild@v3

      - name: ğŸ“Š æ‰§è¡Œ CodeQL åˆ†æ
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript"

  # æµè§ˆå™¨å…¼å®¹æ€§æµ‹è¯•
  browser-test:
    name: ğŸŒ æµè§ˆå™¨å…¼å®¹æ€§æµ‹è¯•
    runs-on: ubuntu-latest
    needs: [build]
    strategy:
      matrix:
        browser: [chrome, firefox]
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v5

      - name: ğŸ“¦ è®¾ç½® Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¥ å®‰è£…ä¾èµ–
        run: npm ci

      - name: ğŸ“¦ ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v5
        with:
          name: build-files
          path: dist/

      - name: ğŸŒ å¯åŠ¨é¢„è§ˆæœåŠ¡å™¨
        run: |
          npm run preview &
          sleep 5

      - name: ğŸ§ª è¿è¡Œ E2E æµ‹è¯• (${{ matrix.browser }})
        run: |
          # è¿™é‡Œå¯ä»¥æ·»åŠ  Playwright æˆ– Cypress æµ‹è¯•
          echo "Running E2E tests on ${{ matrix.browser }}"

  # éƒ¨ç½²åˆ° GitHub Pages (ä»…åœ¨ main åˆ†æ”¯)
  deploy:
    name: ğŸš€ éƒ¨ç½²åˆ° GitHub Pages
    runs-on: ubuntu-latest
    needs: [lint, test, build, security]
    permissions:
      contents: read
      pages: write
      id-token: write
    concurrency:
      group: "pages"
      cancel-in-progress: true
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v5

      - name: ğŸ“¦ è®¾ç½® Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¥ å®‰è£…ä¾èµ–
        run: npm ci

      - name: ğŸ—ï¸ æ„å»ºé¡¹ç›®
        run: npm run build

      - name: âš™ï¸ è®¾ç½® Pages
        uses: actions/configure-pages@v5

      - name: ğŸ“¤ ä¸Šä¼ åˆ° Pages
        uses: actions/upload-pages-artifact@v4
        with:
          path: './dist'

      - name: ğŸš€ éƒ¨ç½²åˆ° GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # å‘å¸ƒ Release (ä»…åœ¨ release äº‹ä»¶)
  release:
    name: ğŸ“¦ å‘å¸ƒ Release
    runs-on: ubuntu-latest
    needs: [lint, test, build, security]
    if: github.event_name == 'release'
    permissions:
      contents: write
      actions: read
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v5

      - name: ğŸ“¦ è®¾ç½® Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¥ å®‰è£…ä¾èµ–
        run: npm ci

      - name: ğŸ—ï¸ æ„å»ºé¡¹ç›®
        run: npm run build

      - name: ğŸ“¦ æ‰“åŒ…å‘å¸ƒæ–‡ä»¶
        run: |
          zip -r release.zip dist/ README.md LICENSE CHANGELOG.md

      - name: ğŸ“¤ ä¸Šä¼  Release èµ„äº§
        uses: softprops/action-gh-release@v2
        with:
          files: release.zip
          name: secure-password-generator-${{ github.event.release.tag_name }}.zip
          token: ${{ secrets.GITHUB_TOKEN }}

  # ä¾èµ–æ›´æ–°æ£€æŸ¥ (æ¯å‘¨è¿è¡Œ)
  dependency-update:
    name: ğŸ”„ ä¾èµ–æ›´æ–°æ£€æŸ¥
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v5

      - name: ğŸ“¦ è®¾ç½® Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ” æ£€æŸ¥è¿‡æ—¶ä¾èµ–
        run: npm outdated || true

      - name: ğŸ”’ å®‰å…¨å®¡è®¡
        run: npm audit || true